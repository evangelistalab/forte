import forte

# ASET2-[DSRG-MRPT3] with CASSCF optimized density

refmcscf = -9.069018284886
refaset2 = -9.088090939391

molecule {
r1=1.65
    0 1
    Li      0.0  0.0  0.0
    H       0.0  0.0  r1
--
    H      0.0  0.0  4.8
    H      0.0  0.0  5.57
    
     units angstrom
     no_reorient
     symmetry c1
}

set {
  basis                  3-21g
  reference              rohf
  scf_type               direct
  diis                   true
  diis_start             11
  maxiter                300
  soscf                  true
  soscf_max_iter         35
  damping_percentage     40
  fail_on_maxiter        false
  e_convergence          12
  d_convergence          8
  docc                   [3]
  restricted_docc        [2]
  active                 [2]
  mcscf_maxiter          500
  mcscf_algorithm        ts
  mcscf_r_convergence    7
  mcscf_e_convergence    11
  mcscf_diis_start       50
  mcscf_max_rot          0.2
}

E, wfn_cas = energy('casscf', return_wfn = True)
compare_values(refmcscf,variable("CURRENT ENERGY"),8,"MCSCF energy")

set forte {
# Embedding settings
  job_type ASET2
  embedding true
  embedding_threshold 0.5
  embedding_reference casscf

# Fragment methods and space info:
   active_space_solver    fci
   FRAG_CORRELATION_SOLVER     mrdsrg
   FRAG_CORR_LEVEL        pt3
   INT_TYPE_FRAG          conventional

# Environment (interaction) methods
   FRAGMENT_DENSITY       CASSCF    # Optimize the density
   ENV_CORRELATION_SOLVER      mrdsrg
   ENV_CORR_LEVEL         pt2
   INT_TYPE_ENV           conventional

# DSRG settings
   threepdc               zero # Current CASSCF code do not return 3-RDM
   semi_canonical         false
   relax_ref              once
   fci_maxiter            100
   root_sym               0
   nroot                  1
   root                   0
   dsrg_s                 0.5
}

Eforte, wfn = energy('forte', ref_wfn = wfn_cas, return_wfn=True)
compare_values(refaset2,variable("CURRENT ENERGY"),8,"ASET2-[DSRG-MRPT3] (Density Optimization) energy")
